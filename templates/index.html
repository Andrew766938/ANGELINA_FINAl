<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è –ö—Ä—ã–ª—å—è –æ–Ω–ª–∞–π–Ω</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- ============== AUTH MODAL ============== -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-box">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è</h1>
                <p class="subtitle">–û–Ω–ª–∞–π–Ω —Å–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤</p>
                
                <div style="display: flex; gap: 30px;">
                    <!-- LOGIN FORM -->
                    <div id="login-form" class="auth-form active" style="flex: 1;">
                        <h2>–í—Ö–æ–¥</h2>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="login-email" placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label>–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="login-password" placeholder="user123">
                        </div>
                        <button class="btn-auth" onclick="login()">üîì –í–û–ô–¢–ò</button>
                        <p class="auth-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="switchAuthForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                        
                        <!-- –ö–≤–∏–∫ –∞–∫–∫–∞—É–Ω—Ç—ã -->
                        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #48bb78;">
                            <p style="margin: 0 0 10px 0; color: #2d3748; font-weight: 600;">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
                            <p style="margin: 5px 0; color: #4a5568; font-size: 12px;">
                                <strong>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                                üìß user@example.com<br>
                                üîê user123
                            </p>
                            <p style="margin: 10px 0 5px 0; color: #4a5568; font-size: 12px;">
                                <strong>üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</strong><br>
                                üìß admin@example.com<br>
                                üîê admin123
                            </p>
                        </div>
                    </div>
                    
                    <!-- REGISTER FORM -->
                    <div id="register-form" class="auth-form" style="flex: 1;">
                        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                        <div class="form-group">
                            <label>–§–ò–û</label>
                            <input type="text" id="register-name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="register-email" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="register-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                        </div>
                        <div class="form-group">
                            <label>–†–æ–ª—å</label>
                            <select id="register-role" class="role-select">
                                <option value="user">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                <option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </div>
                        <button class="btn-auth" onclick="register()">‚úçÔ∏è –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø</button>
                        <p class="auth-link">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="switchAuthForm()">–í–æ–π—Ç–∏</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ============== MAIN APP ============== -->
    <div id="app" class="app hidden">
        <!-- NAVBAR -->
        <nav class="navbar">
            <div class="navbar-brand">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è</h1>
            </div>
            <div class="navbar-menu">
                <button class="nav-btn active" onclick="switchMainTab('flights')">üõ´ –†–µ–π—Å—ã</button>
                <button class="nav-btn" onclick="switchMainTab('airports')">üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç—ã</button>
                <button class="nav-btn" onclick="switchMainTab('bookings')">üé´ –ë–∏–ª–µ—Ç—ã</button>
                <button class="nav-btn" onclick="switchMainTab('account')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="nav-btn logout" onclick="logout()">üö™ –í–´–•–û–î</button>
            </div>
        </nav>


        <div class="container">
            <!-- ============== FLIGHTS TAB ============== -->
            <div id="flights" class="tab active">
                <h2>üõ´ –ü–æ–∏—Å–∫ —Ä–µ–π—Å–æ–≤</h2>
                
                <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div id="booking-form-section" class="form-card" style="display: none; margin-bottom: 25px;">
                    <h3>üéüÔ∏è –û—Ñ–æ—Ä–º–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <div class="form-row">
                        <input type="hidden" id="booking-flight-id">
                        <span style="grid-column: 1/-1; color: #2d3748; font-weight: 600;" id="booking-flight-info">-</span>
                    </div>
                    <div class="form-row">
                        <input type="text" id="booking-name" placeholder="–§–ò–û –ø–∞—Å—Å–∞–∂–∏—Ä–∞">
                        <input type="email" id="booking-email" placeholder="Email">
                    </div>
                    <div class="form-row">
                        <input type="tel" id="booking-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                        <input type="number" id="booking-seats" placeholder="–ö–æ–ª-–≤–æ –º–µ—Å—Ç" min="1" value="1">
                    </div>
                    <button class="btn-primary" onclick="createBooking()">‚úÖ –ë–†–û–ù–ò–†–û–í–ê–¢–¨</button>
                    <button class="btn-secondary" onclick="clearBookingForm()" style="background: #e2e8f0; color: #718096; margin-top: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
                
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchFlightTab('all')">üìã –í—Å–µ —Ä–µ–π—Å—ã</button>
                    <button class="tab-btn" onclick="switchFlightTab('search')">üîç –ü–æ–∏—Å–∫</button>
                </div>


                <!-- All Flights -->
                <div id="all-flights-tab" class="tab active">
                    <div id="flights-list" class="cards-grid"></div>
                </div>


                <!-- Search Flights -->
                <div id="search-flights-tab" class="tab">
                    <div class="form-card">
                        <h3>üîç –ü–æ–∏—Å–∫ —Ä–µ–π—Å–æ–≤</h3>
                        <div class="form-row">
                            <input type="number" id="search-from" placeholder="ID –æ—Ç–∫—É–¥–∞">
                            <input type="number" id="search-to" placeholder="ID –∫—É–¥–∞">
                        </div>
                        <button class="btn-primary" onclick="searchFlights()">üîé –ù–ê–ô–¢–ò</button>
                    </div>
                    <div id="search-results" class="cards-grid"></div>
                </div>
            </div>


            <!-- ============== AIRPORTS TAB ============== -->
            <div id="airports" class="tab">
                <h2>üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç—ã</h2>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
                <div id="create-airport-section" style="display: none; margin-bottom: 20px;">
                    <div class="form-card">
                        <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç</h3>
                        <div class="form-row">
                            <input type="text" id="airport-code" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: MOW)">
                            <input type="text" id="airport-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                        </div>
                        <div class="form-row">
                            <input type="text" id="airport-city" placeholder="–ì–æ—Ä–æ–¥">
                            <input type="text" id="airport-country" placeholder="–°—Ç—Ä–∞–Ω–∞">
                        </div>
                        <button class="btn-primary" onclick="createAirport()">‚úÖ –°–û–ó–î–ê–¢–¨</button>
                    </div>
                </div>
                
                <div id="airports-list" class="cards-grid"></div>
            </div>


            <!-- ============== BOOKINGS TAB ============== -->
            <div id="bookings" class="tab">
                <h2>üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã</h2>
                
                <!-- –¢–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤ -->
                <div id="bookings-list" class="cards-grid"></div>
            </div>


            <!-- ============== ACCOUNT TAB ============== -->
            <div id="account" class="tab">
                <h2>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                
                <div class="account-section">
                    <h3>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <p>
                        <strong>–§–ò–û:</strong>
                        <span id="acc-name">-</span>
                    </p>
                    <p>
                        <strong>Email:</strong>
                        <span id="acc-email">-</span>
                    </p>
                    <p>
                        <strong>–†–æ–ª—å:</strong>
                        <span id="acc-role">-</span>
                    </p>
                    <p>
                        <strong>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞:</strong>
                        <span id="acc-date">-</span>
                    </p>
                </div>
            </div>
        </div>
    </div>


    <!-- NOTIFICATION -->
    <div id="notification" class="notification"></div>


    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        
        // ========== –ö–ï–®–ï –î–ê–ù–ù–´–• –í –ü–ê–ú–Ø–¢–∏ ==========
        let cachedFlights = [];
        let cachedAirports = [];
        let cachedBookings = [];

        // ========== –°–û–°—Ç–û–Ø–ù–ò–ï –í–ö–õ–ê–î–û–ö ==========
        let currentFlightTab = 'all';
        let selectedFlightForBooking = null;

        // ========== DEMO-–î–ê–ù–ù–´–ï (FALLBACK) ==========
        const DEMO_FLIGHTS = [
            { id: 1, flight_number: 'SU-001', airline: '–ê—ç—Ä–æ—Ñ–ª–æ—Ç', departure_airport_id: 1, arrival_airport_id: 2, departure_time: new Date().toISOString(), price: 5500, total_seats: 180, available_seats: 180 },
            { id: 2, flight_number: 'SU-002', airline: '–ê—ç—Ä–æ—Ñ–ª–æ—Ç', departure_airport_id: 2, arrival_airport_id: 1, departure_time: new Date().toISOString(), price: 5500, total_seats: 180, available_seats: 145 },
            { id: 3, flight_number: 'U6-100', airline: '–£—Ä–∞–ª—å—Å–∫–∏–µ –∞–≤–∏–∞–ª–∏–Ω–∏–∏', departure_airport_id: 1, arrival_airport_id: 3, departure_time: new Date().toISOString(), price: 4800, total_seats: 150, available_seats: 150 },
            { id: 4, flight_number: 'UT-50', airline: '–Æ—Ç-–ê—ç—Ä', departure_airport_id: 3, arrival_airport_id: 4, departure_time: new Date().toISOString(), price: 6200, total_seats: 160, available_seats: 160 },
            { id: 5, flight_number: 'S7-500', airline: 'S7 –ê–≤–∏–∞–ª–∏–Ω–∏–∏', departure_airport_id: 2, arrival_airport_id: 4, departure_time: new Date().toISOString(), price: 7200, total_seats: 120, available_seats: 120 },
            { id: 6, flight_number: 'SU-003', airline: '–ê—ç—Ä–æ—Ñ–ª–æ—Ç', departure_airport_id: 1, arrival_airport_id: 5, departure_time: new Date().toISOString(), price: 8500, total_seats: 200, available_seats: 200 },
            { id: 7, flight_number: 'FV-201', airline: '–§–∏–Ω–∏—Ä –∞—ç—Ä–æ', departure_airport_id: 4, arrival_airport_id: 2, departure_time: new Date().toISOString(), price: 6800, total_seats: 140, available_seats: 140 },
            { id: 8, flight_number: 'A4-400', airline: 'A4', departure_airport_id: 1, arrival_airport_id: 6, departure_time: new Date().toISOString(), price: 5200, total_seats: 190, available_seats: 190 },
            { id: 9, flight_number: 'R2-102', airline: '–†—É—Å—Å–∫–∏–µ –∞–≤–∏–∞–ª–∏–Ω–∏–∏', departure_airport_id: 2, arrival_airport_id: 3, departure_time: new Date().toISOString(), price: 5800, total_seats: 170, available_seats: 170 },
            { id: 10, flight_number: 'FP-55', airline: '–§–ª–∞–º–∏–Ω–≥–æ', departure_airport_id: 3, arrival_airport_id: 1, departure_time: new Date().toISOString(), price: 5400, total_seats: 160, available_seats: 160 },
            { id: 11, flight_number: 'N1-555', airline: '–ù–æ–≤—ã–µ –≤–µ–∫–∞', departure_airport_id: 1, arrival_airport_id: 7, departure_time: new Date().toISOString(), price: 7800, total_seats: 210, available_seats: 210 },
            { id: 12, flight_number: 'V1-888', airline: '–í—ã—Å–æ—Ç–∞', departure_airport_id: 2, arrival_airport_id: 8, departure_time: new Date().toISOString(), price: 8200, total_seats: 140, available_seats: 140 },
            { id: 13, flight_number: 'E3-200', airline: '–≠–∫—Å–ø—Ä–µ—Å—Å', departure_airport_id: 1, arrival_airport_id: 4, departure_time: new Date().toISOString(), price: 6500, total_seats: 150, available_seats: 150 },
            { id: 14, flight_number: 'G5-777', airline: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞', departure_airport_id: 3, arrival_airport_id: 2, departure_time: new Date().toISOString(), price: 5700, total_seats: 180, available_seats: 180 },
            { id: 15, flight_number: 'T4-999', airline: '–¢–∞–Ω–¥–µ–º', departure_airport_id: 4, arrival_airport_id: 3, departure_time: new Date().toISOString(), price: 4200, total_seats: 120, available_seats: 120 },
            { id: 16, flight_number: 'L7-333', airline: '–õ—É—á', departure_airport_id: 1, arrival_airport_id: 9, departure_time: new Date().toISOString(), price: 9200, total_seats: 200, available_seats: 200 },
        ];

        const DEMO_AIRPORTS = [
            { id: 1, code: 'MOW', name: '–®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ', city: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è' },
            { id: 2, code: 'SPB', name: '–ü—É–ª–∫–æ–≤–æ', city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', country: '–†–æ—Å—Å–∏—è' },
            { id: 3, code: 'KZN', name: '–ö–∞–∑–∞–Ω—å', city: '–ö–∞–∑–∞–Ω—å', country: '–†–æ—Å—Å–∏—è' },
            { id: 4, code: 'SVX', name: '–ö–æ–ª—å—Ü–æ–≤–æ', city: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', country: '–†–æ—Å—Å–∏—è' },
            { id: 5, code: 'YKA', name: '–ü–ª–æ—â–∞–¥—å –õ–µ–Ω–∏–Ω–∞', city: '–Ø–∫—É—Ç—Å–∫', country: '–†–æ—Å—Å–∏—è' },
            { id: 6, code: 'LED', name: '–ü—É–ª–∫–æ–≤–æ-2', city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', country: '–†–æ—Å—Å–∏—è' },
            { id: 7, code: 'NOV', name: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', city: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', country: '–†–æ—Å—Å–∏—è' },
            { id: 8, code: 'VVO', name: '–ù–æ–≤—ã–π –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', city: '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', country: '–†–æ—Å—Å–∏—è' },
            { id: 9, code: 'OVB', name: '–û–±—å', city: '–û–±—å', country: '–†–æ—Å—Å–∏—è' },
            { id: 10, code: 'UUS', name: '–Æ–∂–Ω–æ—Å–∞—Ö–∞–ª–∏–Ω—Å–∫', city: '–Æ–∂–Ω–æ—Å–∞—Ö–∞–ª–∏–Ω—Å–∫', country: '–†–æ—Å—Å–∏—è' },
            { id: 11, code: 'TOE', name: '–¢–æ–ª—è—Ç–∏', city: '–¢–æ–ª—è—Ç–∏', country: '–†–æ—Å—Å–∏—è' },
            { id: 12, code: 'PEE', name: '–ü–µ—Ä–º—å', city: '–ü–µ—Ä–º—å', country: '–†–æ—Å—Å–∏—è' },
            { id: 13, code: 'TJM', name: '–¢—é–º–µ–Ω—å', city: '–¢—é–º–µ–Ω—å', country: '–†–æ—Å—Å–∏—è' },
            { id: 14, code: 'IGT', name: '–ò—Ä–∫—É—Ç—Å–∫', city: '–ò—Ä–∫—É—Ç—Å–∫', country: '–†–æ—Å—Å–∏—è' },
            { id: 15, code: 'ULY', name: '–£–ª–∞–Ω-–£–¥—ç', city: '–£–ª–∞–Ω-–£–¥—ç', country: '–†–æ—Å—Å–∏—è' },
            { id: 16, code: 'CHI', name: '–ß–∏—Ç–∞', city: '–ß–∏—Ç–∞', country: '–†–æ—Å—Å–∏—è' },
        ];

        const DEMO_BOOKINGS = [
            { id: 1, booking_number: 'BK-001', passenger_name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', passenger_email: 'ivan@example.com', passenger_phone: '+7 999 111-00-01', seats_count: 1, status: 'pending' },
            { id: 2, booking_number: 'BK-002', passenger_name: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞', passenger_email: 'maria@example.com', passenger_phone: '+7 999 222-00-02', seats_count: 2, status: 'pending' },
            { id: 3, booking_number: 'BK-003', passenger_name: '–ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤', passenger_email: 'alex@example.com', passenger_phone: '+7 999 333-00-03', seats_count: 1, status: 'completed' },
            { id: 4, booking_number: 'BK-004', passenger_name: '–ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞', passenger_email: 'elena@example.com', passenger_phone: '+7 999 444-00-04', seats_count: 1, status: 'pending' },
        ];


        // ============== INIT ==============
        document.addEventListener('DOMContentLoaded', () => {
            showAuthModal();
        });


        // ============== AUTH ==============
        function switchAuthForm() {
            document.getElementById('login-form').classList.toggle('active');
            document.getElementById('register-form').classList.toggle('active');
        }

        function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) {
                notify('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            const role = email.includes('admin') ? 'admin' : 'user';
            currentUser = {
                name: email.split('@')[0],
                email: email,
                role: role,
                loginTime: new Date().toLocaleString('ru-RU')
            };
            showApp();
            notify('‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!', 'success');
        }


        function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const role = document.getElementById('register-role').value;
            
            if (!name || !email || !password) {
                notify('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            currentUser = {
                name: name,
                email: email,
                role: role,
                loginTime: new Date().toLocaleString('ru-RU')
            };
            showApp();
            notify(`‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ ${role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!`, 'success');
        }


        function logout() {
            currentUser = null;
            cachedFlights = [];
            cachedAirports = [];
            cachedBookings = [];
            showAuthModal();
            notify('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
        }


        // ============== UI ==============
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }


        async function showApp() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateAccountTab();
            
            if (currentUser.role === 'admin') {
                document.getElementById('create-airport-section').style.display = 'block';
            } else {
                document.getElementById('create-airport-section').style.display = 'none';
            }
            
            await loadAllFlights();
            await loadAllAirports();
            await loadMyBookings();
        }


        function switchMainTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn:not(.logout)').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            const btns = document.querySelectorAll('.nav-btn:not(.logout)');
            const tabMap = { flights: 0, airports: 1, bookings: 2, account: 3 };
            const idx = tabMap[tabName];
            if (idx !== undefined && btns[idx]) {
                btns[idx].classList.add('active');
            }
            
            if (tabName === 'flights') {
                switchFlightTab(currentFlightTab);
            }
        }


        function switchFlightTab(tab) {
            currentFlightTab = tab;
            document.getElementById('all-flights-tab').classList.toggle('active', tab === 'all');
            document.getElementById('search-flights-tab').classList.toggle('active', tab === 'search');
            document.querySelectorAll('#flights .tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'all') || (i === 1 && tab === 'search'));
            });
        }


        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = `notification show ${type}`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }


        // ============== ACCOUNT ==============
        function updateAccountTab() {
            if (!currentUser) return;
            document.getElementById('acc-name').textContent = currentUser.name;
            document.getElementById('acc-email').textContent = currentUser.email;
            const roleText = currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('acc-role').textContent = roleText;
            document.getElementById('acc-date').textContent = currentUser.loginTime;
        }


        // ============== FLIGHTS ==============
        async function loadAllFlights() {
            try {
                const res = await fetch(`${API_URL}/flights/`, { timeout: 2000 });
                if (!res.ok) throw new Error('API error');
                const flights = await res.json();
                if (flights && flights.length > 0) {
                    cachedFlights = flights;
                } else {
                    cachedFlights = DEMO_FLIGHTS;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∂–∫–∏ —Ä–µ–π—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º DEMO:', e);
                cachedFlights = DEMO_FLIGHTS;
            }
            renderFlights();
        }

        function renderFlights() {
            const list = document.getElementById('flights-list');
            if (!cachedFlights || cachedFlights.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">‚úàÔ∏è –†–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            list.innerHTML = cachedFlights.map(f => `
                <div class="card">
                    <h3>${f.flight_number}</h3>
                    <p><strong>üé´ ${f.airline}</strong></p>
                    <p><strong>üìç –ú–∞—Ä—à—Ä—É—Ç:</strong> ${f.departure_airport_id} ‚û°Ô∏è ${f.arrival_airport_id}</p>
                    <p><strong>‚è∞ –í—ã–ª–µ—Ç:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                    <p><strong>üí∞ –¶–µ–Ω–∞:</strong> <span style="color: #48bb78; font-weight: 700;">‚ÇΩ${f.price}</span></p>
                    <p><strong>üí∫ –ú–µ—Å—Ç–∞:</strong> ${f.available_seats}/${f.total_seats}</p>
                    <button class="btn-select" onclick="selectFlight(${f.id}, '${f.flight_number}', ${f.departure_airport_id}, ${f.arrival_airport_id}, ${f.price})">üéüÔ∏è –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨</button>
                </div>
            `).join('');
        }


        async function searchFlights() {
            const from = document.getElementById('search-from').value.trim();
            const to = document.getElementById('search-to').value.trim();
            if (!from || !to) {
                notify('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –û–ë–ê –ø–æ–ª—è', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_URL}/flights/?departure_airport_id=${from}&arrival_airport_id=${to}`);
                if (!res.ok) throw new Error();
                const flights = await res.json();
                const list = document.getElementById('search-results');
                if (!flights || flights.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">‚úàÔ∏è –†–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                list.innerHTML = flights.map(f => `
                    <div class="card">
                        <h3>${f.flight_number}</h3>
                        <p><strong>üé´ ${f.airline}</strong></p>
                        <p><strong>üìç –ú–∞—Ä—à—Ä—É—Ç:</strong> ${f.departure_airport_id} ‚û°Ô∏è ${f.arrival_airport_id}</p>
                        <p><strong>‚è∞ –í—ã–ª–µ—Ç:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                        <p><strong>üí∞ –¶–µ–Ω–∞:</strong> <span style="color: #48bb78; font-weight: 700;">‚ÇΩ${f.price}</span></p>
                        <p><strong>üí∫ –ú–µ—Å—Ç–∞:</strong> ${f.available_seats}/${f.total_seats}</p>
                        <button class="btn-select" onclick="selectFlight(${f.id}, '${f.flight_number}', ${f.departure_airport_id}, ${f.arrival_airport_id}, ${f.price})">üéüÔ∏è –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨</button>
                    </div>
                `).join('');
                notify(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${flights.length} —Ä–µ–π—Å–æ–≤`, 'success');
            } catch (e) {
                console.error(e);
                notify('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
            }
        }


        function selectFlight(id, flightNumber, fromId, toId, price) {
            selectedFlightForBooking = { id, flightNumber, fromId, toId, price };
            document.getElementById('booking-flight-id').value = id;
            document.getElementById('booking-flight-info').textContent = `‚úàÔ∏è ${flightNumber} | –ú–∞—Ä—à—Ä—É—Ç: ${fromId} ‚û°Ô∏è ${toId} | –¶–µ–Ω–∞: ‚ÇΩ${price}`;
            document.getElementById('booking-form-section').style.display = 'block';
            document.getElementById('booking-name').focus();
            notify('‚úÖ –†–µ–π—Å –≤—ã–±—Ä–∞–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!', 'success');
        }

        function clearBookingForm() {
            selectedFlightForBooking = null;
            document.getElementById('booking-flight-id').value = '';
            document.getElementById('booking-flight-info').textContent = '-';
            document.getElementById('booking-form-section').style.display = 'none';
            document.getElementById('booking-name').value = '';
            document.getElementById('booking-email').value = '';
            document.getElementById('booking-phone').value = '';
            document.getElementById('booking-seats').value = '1';
        }

        async function createBooking() {
            const flightId = document.getElementById('booking-flight-id').value;
            const name = document.getElementById('booking-name').value.trim();
            const email = document.getElementById('booking-email').value.trim();
            const phone = document.getElementById('booking-phone').value.trim();
            const seats = document.getElementById('booking-seats').value.trim() || '1';
            
            if (!flightId) {
                notify('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–π—Å', 'error');
                return;
            }
            if (!name || !email || !phone) {
                notify('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –í–°–ï –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/bookings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flight_id: parseInt(flightId),
                        passenger_name: name,
                        passenger_email: email,
                        passenger_phone: phone,
                        seats_count: parseInt(seats)
                    })
                });
                if (res.ok) {
                    const booking = await res.json();
                    notify(`‚úÖ –ë–∏–ª–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω! ‚Ññ${booking.booking_number || flightId}`, 'success');
                    clearBookingForm();
                    await loadMyBookings();
                } else {
                    const err = await res.json();
                    notify(`‚ùå ${err.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                notify('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }


        // ============== AIRPORTS ==============
        async function loadAllAirports() {
            try {
                const res = await fetch(`${API_URL}/flights/airports/`, { timeout: 2000 });
                if (!res.ok) throw new Error('API error');
                const airports = await res.json();
                if (airports && airports.length > 0) {
                    cachedAirports = airports;
                } else {
                    cachedAirports = DEMO_AIRPORTS;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∂–∫–∏ –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º DEMO:', e);
                cachedAirports = DEMO_AIRPORTS;
            }
            renderAirports();
        }

        function renderAirports() {
            const list = document.getElementById('airports-list');
            if (!cachedAirports || cachedAirports.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            list.innerHTML = cachedAirports.map(a => `
                <div class="card">
                    <h3>‚úàÔ∏è ${a.code}</h3>
                    <p><strong>${a.name}</strong></p>
                    <p><strong>üèôÔ∏è –ì–æ—Ä–æ–¥:</strong> ${a.city}</p>
                    <p><strong>üåç –°—Ç—Ä–∞–Ω–∞:</strong> ${a.country}</p>
                </div>
            `).join('');
        }

        async function createAirport() {
            if (currentUser.role !== 'admin') {
                notify('‚ö†Ô∏è –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã', 'error');
                return;
            }
            
            const code = document.getElementById('airport-code').value.trim();
            const name = document.getElementById('airport-name').value.trim();
            const city = document.getElementById('airport-city').value.trim();
            const country = document.getElementById('airport-country').value.trim();
            
            if (!code || !name || !city || !country) {
                notify('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/flights/airports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code.toUpperCase(), name, city, country })
                });
                
                if (res.ok) {
                    notify('‚úÖ –ê—ç—Ä–æ–ø–æ—Ä—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
                    document.getElementById('airport-code').value = '';
                    document.getElementById('airport-name').value = '';
                    document.getElementById('airport-city').value = '';
                    document.getElementById('airport-country').value = '';
                    cachedAirports = [];
                    await loadAllAirports();
                } else {
                    const err = await res.json();
                    notify(`‚ùå ${err.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                notify('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }


        // ============== BOOKINGS ==============
        async function loadMyBookings() {
            try {
                const res = await fetch(`${API_URL}/bookings/`, { timeout: 2000 });
                if (!res.ok) throw new Error('API error');
                const bookings = await res.json();
                if (bookings && bookings.length > 0) {
                    cachedBookings = bookings;
                } else {
                    cachedBookings = DEMO_BOOKINGS;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∂–∫–∏ –±–∏–ª–µ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º DEMO:', e);
                cachedBookings = DEMO_BOOKINGS;
            }
            renderBookings();
        }

        function renderBookings() {
            const list = document.getElementById('bookings-list');
            if (!cachedBookings || cachedBookings.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">üé´ –í—ã –µ—â—ë –Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –±–∏–ª–µ—Ç—ã</div>';
                return;
            }
            list.innerHTML = cachedBookings.map(b => {
                let deleteBtn = '';
                if (currentUser.role === 'admin') {
                    deleteBtn = `<button class="btn-delete" onclick="deleteBooking(${b.id}, '${b.booking_number || b.id}')" style="background: #f56565; color: white; margin-top: 10px; width: 100%;">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>`;
                }
                return `
                    <div class="card">
                        <h3>üé´ ‚Ññ${b.booking_number || b.id}</h3>
                        <p><strong>üë§ –ü–∞—Å—Å–∞–∂–∏—Ä:</strong> ${b.passenger_name}</p>
                        <p><strong>üìß Email:</strong> ${b.passenger_email}</p>
                        <p><strong>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${b.passenger_phone}</p>
                        <p><strong>üí∫ –ú–µ—Å—Ç:</strong> ${b.seats_count || 1}</p>
                        <p><strong>‚úÖ –°—Ç–∞—Ç—É—Å:</strong> <span style="color: #48bb78; font-weight: 700;">${b.status || 'pending'}</span></p>
                        ${deleteBtn}
                    </div>
                `;
            }).join('');
        }

        async function deleteBooking(bookingId, bookingNumber) {
            if (currentUser.role !== 'admin') {
                notify('‚ö†Ô∏è –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –±–∏–ª–µ—Ç—ã', 'error');
                return;
            }
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã? –£–¥–∞–ª–∏—Ç—å –±–∏–ª–µ—Ç ${bookingNumber}?`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/bookings/${bookingId}?is_admin=true`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (res.ok) {
                    notify(`‚úÖ –ë–∏–ª–µ—Ç ${bookingNumber} —É–¥–∞–ª–µ–Ω!`, 'success');
                    await loadMyBookings();
                } else {
                    const err = await res.json();
                    notify(`‚ùå ${err.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                notify('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }
    </script>
</body>
</html>