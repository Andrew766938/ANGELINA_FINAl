        let sortedFlights = [];
        let currentSort = 'none';

        function sortAndRenderFlights() {
            const sortValue = document.getElementById('sort-select').value;
            currentSort = sortValue;
            
            sortedFlights = [...cachedFlights];
            
            if (sortValue === 'dep-city') {
                sortedFlights.sort((a, b) => a.departure_airport.city.localeCompare(b.departure_airport.city, 'ru'));
            } else if (sortValue === 'arr-city') {
                sortedFlights.sort((a, b) => a.arrival_airport.city.localeCompare(b.arrival_airport.city, 'ru'));
            } else if (sortValue === 'price-asc') {
                sortedFlights.sort((a, b) => a.price - b.price);
            } else if (sortValue === 'price-desc') {
                sortedFlights.sort((a, b) => b.price - a.price);
            }
            
            renderFlightsFromArray(sortedFlights);
        }

        function renderFlightsFromArray(flights) {
            const list = document.getElementById('flights-list');
            if (!flights || flights.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">âœˆï¸ Ğ ĞµĞ¹ÑÑ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</div>';
                return;
            }
            list.innerHTML = flights.map(f => {
                const bookBtn = currentUser && currentUser.role === 'guest'
                    ? '<p style="color: #a0aec0; font-size: 13px; margin-top: 10px;">ğŸ‘€ Ğ“Ğ¾ÑÑ‚ĞµĞ²Ğ¾Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€</p>'
                    : `<button class="btn-select book-btn" onclick="selectFlight(${f.id}, '${f.flight_number}', ${f.departure_airport_id}, ${f.arrival_airport_id}, ${f.price})">ğŸŸï¸ Ğ—ĞĞ‘Ğ ĞĞĞ˜Ğ ĞĞ’ĞĞ¢Ğ¬</button>`;
                
                return `
                    <div class="card">
                        <h3>${f.flight_number}</h3>
                        <p><strong>ğŸ« ${f.airline}</strong></p>
                        <p><strong>ğŸ“ ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong> ${f.departure_airport.city} (${f.departure_airport.code}) â¡ï¸ ${f.arrival_airport.city} (${f.arrival_airport.code})</p>
                        <p><strong>â° Ğ’Ñ‹Ğ»ĞµÑ‚:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                        <p><strong>ğŸ’° Ğ¦ĞµĞ½Ğ°:</strong> <span style="color: #48bb78; font-weight: 700;">â‚½${f.price}</span></p>
                        <p><strong>ğŸ’º ĞœĞµÑÑ‚Ğ°:</strong> ${f.available_seats}/${f.total_seats}</p>
                        ${bookBtn}
                    </div>
                `;
            }).join('');
        }