<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крылья онлайн</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <!-- Навигация -->
        <nav class="navbar">
            <div class="navbar-brand">
                <h1>✈️ Крылья онлайн</h1>
                <p>Система бронирования авиабилетов</p>
            </div>
            <div class="navbar-menu">
                <button class="nav-btn active" onclick="switchTab('flights')">Flights</button>
                <button class="nav-btn" onclick="switchTab('airports')">Airports</button>
                <button class="nav-btn" onclick="switchTab('bookings')">Bookings</button>
            </div>
        </nav>

        <!-- Основное содержание -->
        <div class="content">
            <!-- Рейсы -->
            <div id="flights" class="tab active">
                <h2>✈️ Найти рейсы</h2>
                <div class="search-form">
                    <div class="form-group">
                        <label>Откуда (ID):</label>
                        <input type="number" id="from-id" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Куда (ID):</label>
                        <input type="number" id="to-id" placeholder="2">
                    </div>
                    <div class="form-group">
                        <button onclick="loadFlights()">Load All Flights</button>
                        <button onclick="searchFlights()">Search</button>
                    </div>
                </div>
                <div id="flights-list" class="flights-list"></div>
            </div>

            <!-- Аэропорты -->
            <div id="airports" class="tab">
                <h2>Аэропорты</h2>
                <div class="form-card">
                    <h3>Добавить аэропорт</h3>
                    <input type="text" id="airport-code" placeholder="Code (MOW)">
                    <input type="text" id="airport-name" placeholder="Name">
                    <input type="text" id="airport-city" placeholder="City">
                    <input type="text" id="airport-country" placeholder="Country">
                    <button onclick="addAirport()">Add Airport</button>
                </div>
                <div id="airports-list" class="list"></div>
            </div>

            <!-- Бронирования -->
            <div id="bookings" class="tab">
                <h2>Бронирование</h2>
                <div class="form-card">
                    <h3>Составить бронь</h3>
                    <input type="number" id="booking-flight-id" placeholder="Flight ID">
                    <input type="text" id="booking-name" placeholder="Passenger Name">
                    <input type="email" id="booking-email" placeholder="Email">
                    <input type="tel" id="booking-phone" placeholder="Phone">
                    <button onclick="createBooking()">Book</button>
                </div>
                <div id="bookings-list" class="list"></div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification"></div>

    <script>
        const API_URL = 'http://localhost:8000';

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification show ${type}`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        async function loadFlights() {
            try {
                const response = await fetch(`${API_URL}/flights/`);
                const flights = await response.json();
                displayFlights(flights);
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error loading flights', 'error');
            }
        }

        async function searchFlights() {
            const fromId = document.getElementById('from-id').value;
            const toId = document.getElementById('to-id').value;
            if (!fromId || !toId) {
                showNotification('Please enter both airport IDs', 'error');
                return;
            }
            try {
                const url = `${API_URL}/flights/?departure_airport_id=${fromId}&arrival_airport_id=${toId}`;
                const response = await fetch(url);
                const flights = await response.json();
                displayFlights(flights);
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error searching flights', 'error');
            }
        }

        function displayFlights(flights) {
            const list = document.getElementById('flights-list');
            if (!flights || flights.length === 0) {
                list.innerHTML = '<p>No flights found</p>';
                return;
            }
            list.innerHTML = flights.map(f => `
                <div class="card">
                    <h4>${f.flight_number} - ${f.airline}</h4>
                    <p><strong>From:</strong> ${f.departure_airport_id} | <strong>To:</strong> ${f.arrival_airport_id}</p>
                    <p><strong>Departure:</strong> ${new Date(f.departure_time).toLocaleString()}</p>
                    <p><strong>Available seats:</strong> ${f.available_seats}/${f.total_seats}</p>
                    <p><strong>Price:</strong> ₽${f.price}</p>
                    <button onclick="selectFlight(${f.id})">Select</button>
                </div>
            `).join('');
        }

        function selectFlight(flightId) {
            document.getElementById('booking-flight-id').value = flightId;
            switchTab('bookings');
        }

        async function addAirport() {
            const code = document.getElementById('airport-code').value;
            const name = document.getElementById('airport-name').value;
            const city = document.getElementById('airport-city').value;
            const country = document.getElementById('airport-country').value;

            if (!code || !name || !city || !country) {
                showNotification('Fill all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/flights/airports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name, city, country })
                });
                if (response.ok) {
                    showNotification('Airport added!');
                    document.getElementById('airport-code').value = '';
                    document.getElementById('airport-name').value = '';
                    document.getElementById('airport-city').value = '';
                    document.getElementById('airport-country').value = '';
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error adding airport', 'error');
            }
        }

        async function createBooking() {
            const flightId = document.getElementById('booking-flight-id').value;
            const name = document.getElementById('booking-name').value;
            const email = document.getElementById('booking-email').value;
            const phone = document.getElementById('booking-phone').value;

            if (!flightId || !name || !email || !phone) {
                showNotification('Fill all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/bookings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flight_id: parseInt(flightId),
                        passenger_name: name,
                        passenger_email: email,
                        passenger_phone: phone,
                        status: 'CONFIRMED'
                    })
                });
                if (response.ok) {
                    const booking = await response.json();
                    showNotification(`Booked! Number: ${booking.booking_number}`);
                    document.getElementById('booking-flight-id').value = '';
                    document.getElementById('booking-name').value = '';
                    document.getElementById('booking-email').value = '';
                    document.getElementById('booking-phone').value = '';
                } else {
                    showNotification('Booking error', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error booking', 'error');
            }
        }

        // Load flights on page load
        window.addEventListener('load', () => {
            console.log('Page loaded');
            loadFlights();
        });
    </script>
</body>
</html>
