<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è –ö—Ä—ã–ª—å—è –æ–Ω–ª–∞–π–Ω</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- ============== AUTH MODAL ============== -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-box">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è</h1>
                <p class="subtitle">–û–Ω–ª–∞–π–Ω —Å–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                
                <!-- LOGIN FORM -->
                <div id="login-form" class="auth-form active">
                    <h2>–í—Ö–æ–¥</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="demo@example.com" value="demo@example.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="login-password" placeholder="demo123" value="demo123">
                    </div>
                    <button class="btn-auth" onclick="login()">–í–û–ô–¢–ò</button>
                    <p class="auth-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="switchAuthForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                </div>
                
                <!-- REGISTER FORM -->
                <div id="register-form" class="auth-form">
                    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <div class="form-group">
                        <label>–§–ò–û</label>
                        <input type="text" id="register-name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="register-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                    <button class="btn-auth" onclick="register()">–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø</button>
                    <p class="auth-link">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="switchAuthForm()">–í–æ–π—Ç–∏</a></p>
                </div>
                
                <div class="divider"><span>–ò–õ–ò</span></div>
                <button class="btn-guest" onclick="guestLogin()">üë§ –ì–æ—Å—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============== MAIN APP ============== -->
    <div id="app" class="app hidden">
        <!-- NAVBAR -->
        <nav class="navbar">
            <div class="navbar-brand">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è</h1>
            </div>
            <div class="navbar-menu">
                <button class="nav-btn active" onclick="switchMainTab('flights')">Flights</button>
                <button class="nav-btn" onclick="switchMainTab('airports')">Airports</button>
                <button class="nav-btn" onclick="switchMainTab('bookings')">Bookings</button>
                <button class="nav-btn" onclick="switchMainTab('account')">Account</button>
                <button class="nav-btn logout" onclick="logout()">LOGOUT</button>
            </div>
        </nav>

        <div class="container">
            <!-- ============== FLIGHTS TAB ============== -->
            <div id="flights" class="tab active">
                <h2>üéâ –ù–∞–π—Ç–∏ —Ä–µ–π—Å—ã</h2>
                
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchFlightTab('all')">All Flights</button>
                    <button class="tab-btn" onclick="switchFlightTab('search')">Search</button>
                </div>

                <!-- All Flights -->
                <div id="all-flights-tab" class="tab active">
                    <button class="btn-primary" onclick="loadAllFlights()" style="margin-bottom: 20px; max-width: 200px;">üìã Load All Flights</button>
                    <div id="flights-list" class="cards-grid"></div>
                </div>

                <!-- Search Flights -->
                <div id="search-flights-tab" class="tab">
                    <div class="form-card">
                        <h3>üîç –ü–æ–∏—Å–∫ —Ä–µ–π—Å–æ–≤</h3>
                        <div class="form-row">
                            <input type="number" id="search-from" placeholder="ID –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –≤—ã–ª–µ—Ç–∞">
                            <input type="number" id="search-to" placeholder="ID –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –ø—Ä–∏–ª–µ—Ç–∞">
                        </div>
                        <button class="btn-primary" onclick="searchFlights()">üîç –ü–û–ò–°–ö</button>
                    </div>
                    <div id="search-results" class="cards-grid"></div>
                </div>
            </div>

            <!-- ============== AIRPORTS TAB ============== -->
            <div id="airports" class="tab">
                <h2>üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç—ã</h2>
                
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchAirportTab('list')">List</button>
                    <button class="tab-btn" onclick="switchAirportTab('add')">Add New</button>
                </div>

                <!-- Airport List -->
                <div id="airport-list-tab" class="tab active">
                    <button class="btn-primary" onclick="loadAllAirports()" style="margin-bottom: 20px; max-width: 200px;">üìã Load Airports</button>
                    <div id="airports-list" class="cards-grid"></div>
                </div>

                <!-- Add Airport -->
                <div id="airport-add-tab" class="tab">
                    <div class="form-card">
                        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç</h3>
                        <div class="form-row">
                            <input type="text" id="airport-code" placeholder="–ö–æ–¥ (MOW)" maxlength="3">
                            <input type="text" id="airport-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                        </div>
                        <div class="form-row">
                            <input type="text" id="airport-city" placeholder="–ì–æ—Ä–æ–¥">
                            <input type="text" id="airport-country" placeholder="–°—Ç—Ä–∞–Ω–∞">
                        </div>
                        <button class="btn-primary" onclick="addAirport()">‚úÖ –î–û–ë–ê–í–ò–¢–¨</button>
                    </div>
                </div>
            </div>

            <!-- ============== BOOKINGS TAB ============== -->
            <div id="bookings" class="tab">
                <h2>üéüÔ∏è –ú–æ–∏ –±–∏–ª–µ—Ç—ã</h2>
                
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchBookingTab('list')">My Tickets</button>
                    <button class="tab-btn" onclick="switchBookingTab('new')">Book New</button>
                </div>

                <!-- My Bookings -->
                <div id="booking-list-tab" class="tab active">
                    <button class="btn-primary" onclick="loadMyBookings()" style="margin-bottom: 20px; max-width: 200px;">üìã Load My Tickets</button>
                    <div id="bookings-list" class="cards-grid"></div>
                </div>

                <!-- New Booking -->
                <div id="booking-new-tab" class="tab">
                    <div class="form-card">
                        <h3>üéüÔ∏è –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç</h3>
                        <div class="form-row">
                            <input type="number" id="booking-flight" placeholder="ID —Ä–µ–π—Å–∞" min="1">
                        </div>
                        <div class="form-row">
                            <input type="text" id="booking-name" placeholder="–§–ò–û –ø–∞—Å—Å–∞–∂–∏—Ä–∞">
                            <input type="email" id="booking-email" placeholder="Email">
                        </div>
                        <div class="form-row">
                            <input type="tel" id="booking-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                        </div>
                        <button class="btn-primary" onclick="createBooking()">‚úÖ –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨</button>
                    </div>
                </div>
            </div>

            <!-- ============== ACCOUNT TAB ============== -->
            <div id="account" class="tab">
                <h2>üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
                
                <div class="account-section">
                    <h3>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <p>
                        <strong>–§–ò–û:</strong>
                        <span id="acc-name">-</span>
                    </p>
                    <p>
                        <strong>Email:</strong>
                        <span id="acc-email">-</span>
                    </p>
                    <p>
                        <strong>–¢–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞:</strong>
                        <span id="acc-type">-</span>
                    </p>
                    <p>
                        <strong>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞:</strong>
                        <span id="acc-date">-</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="notification"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let myBookings = [];

        // ============== INIT ==============
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            } else {
                showAuthModal();
            }
        });

        // ============== AUTH ==============
        function switchAuthForm() {
            document.getElementById('login-form').classList.toggle('active');
            document.getElementById('register-form').classList.toggle('active');
        }

        function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            currentUser = {
                name: email.split('@')[0],
                email: email,
                type: 'registered',
                loginTime: new Date().toLocaleString('ru-RU')
            };
            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–£—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!', 'success');
        }

        function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            if (!name || !email || !password) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            currentUser = {
                name: name,
                email: email,
                type: 'registered',
                loginTime: new Date().toLocaleString('ru-RU')
            };
            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–£—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
        }

        function guestLogin() {
            currentUser = {
                name: 'Guest',
                email: 'guest@example.com',
                type: 'guest',
                loginTime: new Date().toLocaleString('ru-RU')
            };
            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å', 'success');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            myBookings = [];
            showAuthModal();
            document.getElementById('login-email').value = 'demo@example.com';
            document.getElementById('login-password').value = 'demo123';
            notify('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
        }

        // ============== UI ==============
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateAccountTab();
        }

        function switchMainTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn:not(.logout)').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function switchFlightTab(tab) {
            document.getElementById('all-flights-tab').classList.toggle('active', tab === 'all');
            document.getElementById('search-flights-tab').classList.toggle('active', tab === 'search');
            document.querySelectorAll('#flights .tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'all') || (i === 1 && tab === 'search'));
            });
        }

        function switchAirportTab(tab) {
            document.getElementById('airport-list-tab').classList.toggle('active', tab === 'list');
            document.getElementById('airport-add-tab').classList.toggle('active', tab === 'add');
            document.querySelectorAll('#airports .tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'list') || (i === 1 && tab === 'add'));
            });
        }

        function switchBookingTab(tab) {
            document.getElementById('booking-list-tab').classList.toggle('active', tab === 'list');
            document.getElementById('booking-new-tab').classList.toggle('active', tab === 'new');
            document.querySelectorAll('#bookings .tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'list') || (i === 1 && tab === 'new'));
            });
        }

        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = `notification show ${type}`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // ============== ACCOUNT ==============
        function updateAccountTab() {
            if (!currentUser) return;
            document.getElementById('acc-name').textContent = currentUser.name;
            document.getElementById('acc-email').textContent = currentUser.email;
            document.getElementById('acc-type').textContent = currentUser.type === 'guest' ? '–ì–æ—Å—Ç—å' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
            document.getElementById('acc-date').textContent = currentUser.loginTime;
        }

        // ============== FLIGHTS ==============
        async function loadAllFlights() {
            try {
                const res = await fetch(`${API_URL}/flights/`);
                const flights = await res.json();
                const list = document.getElementById('flights-list');
                if (!flights || flights.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">–†–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                list.innerHTML = flights.map(f => `
                    <div class="card">
                        <h3>${f.flight_number}</h3>
                        <p><strong>${f.airline}</strong></p>
                        <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${f.departure_airport_id} ‚Üí ${f.arrival_airport_id}</p>
                        <p><strong>–í—ã–ª–µ—Ç:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                        <p><strong>–¶–µ–Ω–∞:</strong> <span style="color: #48bb78; font-weight: 700;">‚ÇΩ${f.price}</span></p>
                        <p><strong>–ú–µ—Å—Ç–∞:</strong> ${f.available_seats}/${f.total_seats}</p>
                        <button class="btn-select" onclick="selectFlight(${f.id})">BOOK</button>
                    </div>
                `).join('');
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        async function searchFlights() {
            const from = document.getElementById('search-from').value.trim();
            const to = document.getElementById('search-to').value.trim();
            if (!from || !to) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –û–ë–ê –ø–æ–ª—è', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_URL}/flights/?departure_airport_id=${from}&arrival_airport_id=${to}`);
                const flights = await res.json();
                const list = document.getElementById('search-results');
                if (!flights || flights.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">–†–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                list.innerHTML = flights.map(f => `
                    <div class="card">
                        <h3>${f.flight_number}</h3>
                        <p><strong>${f.airline}</strong></p>
                        <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${f.departure_airport_id} ‚Üí ${f.arrival_airport_id}</p>
                        <p><strong>–í—ã–ª–µ—Ç:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                        <p><strong>–¶–µ–Ω–∞:</strong> <span style="color: #48bb78; font-weight: 700;">‚ÇΩ${f.price}</span></p>
                        <p><strong>–ú–µ—Å—Ç–∞:</strong> ${f.available_seats}/${f.total_seats}</p>
                        <button class="btn-select" onclick="selectFlight(${f.id})">BOOK</button>
                    </div>
                `).join('');
                notify('–ù–∞–π–¥–µ–Ω–æ ' + flights.length + ' —Ä–µ–π—Å–æ–≤', 'success');
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
            }
        }

        function selectFlight(id) {
            document.getElementById('booking-flight').value = id;
            switchMainTab('bookings');
            switchBookingTab('new');
        }

        // ============== AIRPORTS ==============
        async function loadAllAirports() {
            try {
                const res = await fetch(`${API_URL}/flights/airports/`);
                const airports = await res.json();
                const list = document.getElementById('airports-list');
                if (!airports || airports.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">–ê—ç—Ä–æ–ø–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                list.innerHTML = airports.map(a => `
                    <div class="card">
                        <h3>${a.code}</h3>
                        <p><strong>${a.name}</strong></p>
                        <p><strong>–ì–æ—Ä–æ–¥:</strong> ${a.city}</p>
                        <p><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${a.country}</p>
                    </div>
                `).join('');
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        async function addAirport() {
            const code = document.getElementById('airport-code').value.trim().toUpperCase();
            const name = document.getElementById('airport-name').value.trim();
            const city = document.getElementById('airport-city').value.trim();
            const country = document.getElementById('airport-country').value.trim();
            if (!code || !name || !city || !country) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –í–°–ï –ø–æ–ª—è', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_URL}/flights/airports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name, city, country })
                });
                if (res.ok) {
                    notify('–ê—ç—Ä–æ–ø–æ—Ä—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    document.getElementById('airport-code').value = '';
                    document.getElementById('airport-name').value = '';
                    document.getElementById('airport-city').value = '';
                    document.getElementById('airport-country').value = '';
                } else {
                    notify('–û—à–∏–±–∫–∞', 'error');
                }
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        // ============== BOOKINGS ==============
        async function loadMyBookings() {
            try {
                const res = await fetch(`${API_URL}/bookings/`);
                const bookings = await res.json();
                const list = document.getElementById('bookings-list');
                if (!bookings || bookings.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0aec0; padding: 40px;">–í—ã –µ—â–µ –Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –±–∏–ª–µ—Ç—ã</div>';
                    return;
                }
                list.innerHTML = bookings.map(b => `
                    <div class="card">
                        <h3>‚Ññ ${b.booking_number || b.id}</h3>
                        <p><strong>–ü–∞—Å—Å–∞–∂–∏—Ä:</strong> ${b.passenger_name}</p>
                        <p><strong>Email:</strong> ${b.passenger_email}</p>
                        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${b.passenger_phone}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: #48bb78; font-weight: 700;">${b.status || 'CONFIRMED'}</span></p>
                    </div>
                `).join('');
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        async function createBooking() {
            const flight = document.getElementById('booking-flight').value.trim();
            const name = document.getElementById('booking-name').value.trim();
            const email = document.getElementById('booking-email').value.trim();
            const phone = document.getElementById('booking-phone').value.trim();
            if (!flight || !name || !email || !phone) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –í–°–ï –ø–æ–ª—è', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_URL}/bookings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flight_id: parseInt(flight),
                        passenger_name: name,
                        passenger_email: email,
                        passenger_phone: phone
                    })
                });
                if (res.ok) {
                    const booking = await res.json();
                    notify(`–ë–∏–ª–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω ‚Ññ${booking.booking_number || flight}!`, 'success');
                    document.getElementById('booking-flight').value = '';
                    document.getElementById('booking-name').value = '';
                    document.getElementById('booking-email').value = '';
                    document.getElementById('booking-phone').value = '';
                    setTimeout(() => loadMyBookings(), 1000);
                } else {
                    notify('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                }
            } catch (e) {
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }
    </script>
</body>
</html>
