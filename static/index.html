<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è –ö—Ä—ã–ª—å—è –æ–Ω–ª–∞–π–Ω</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- ============== AUTH MODAL ============== -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-box">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è –æ–Ω–ª–∞–π–Ω</h1>
                <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤</p>
                
                <!-- LOGIN FORM -->
                <div id="login-form" class="auth-form active">
                    <h2>–í—Ö–æ–¥</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="demo@example.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="login-password" placeholder="demo123">
                    </div>
                    <button class="btn-auth" onclick="login()">–í–û–ô–¢–ò</button>
                    <p class="auth-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="switchAuthForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                </div>
                
                <!-- REGISTER FORM -->
                <div id="register-form" class="auth-form">
                    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <div class="form-group">
                        <label>–§–ò–û</label>
                        <input type="text" id="register-name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="register-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                    <button class="btn-auth" onclick="register()">–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø</button>
                    <p class="auth-link">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="switchAuthForm()">–í–æ–π—Ç–∏</a></p>
                </div>
                
                <div class="divider"><span>–∏–ª–∏</span></div>
                <button class="btn-guest" onclick="guestLogin()">üë§ –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ============== MAIN APP ============== -->
    <div id="app" class="app hidden">
        <!-- NAVBAR -->
        <nav class="navbar">
            <div class="navbar-brand">
                <h1>‚úàÔ∏è –ö—Ä—ã–ª—å—è –æ–Ω–ª–∞–π–Ω</h1>
            </div>
            <div class="navbar-menu">
                <button class="nav-btn active" onclick="switchTab('flights')">Flights</button>
                <button class="nav-btn" onclick="switchTab('airports')">Airports</button>
                <button class="nav-btn" onclick="switchTab('bookings')">Bookings</button>
                <button class="nav-btn" onclick="switchTab('account')">Account</button>
                <button class="nav-btn logout" onclick="logout()">LOGOUT</button>
            </div>
        </nav>

        <div class="container">
            <!-- ============== FLIGHTS TAB ============== -->
            <div id="flights" class="tab active">
                <h2>‚úàÔ∏è –ü–æ–∏—Å–∫ —Ä–µ–π—Å–æ–≤</h2>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="loadAllFlights()">üìã Load All Flights</button>
                </div>
                <div id="flights-list" class="list"></div>
            </div>

            <!-- ============== AIRPORTS TAB ============== -->
            <div id="airports" class="tab">
                <h2>üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç—ã</h2>
                <div class="form-card">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç</h3>
                    <input type="text" id="airport-code" placeholder="–ö–æ–¥ (MOW)" maxlength="3">
                    <input type="text" id="airport-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ)">
                    <input type="text" id="airport-city" placeholder="–ì–æ—Ä–æ–¥ (–ú–æ—Å–∫–≤–∞)">
                    <input type="text" id="airport-country" placeholder="–°—Ç—Ä–∞–Ω–∞ (–†–æ—Å—Å–∏—è)">
                    <button class="btn-primary" onclick="addAirport()">‚úÖ ADD AIRPORT</button>
                </div>
            </div>

            <!-- ============== BOOKINGS TAB ============== -->
            <div id="bookings" class="tab">
                <h2>üé´ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <div class="form-card">
                    <h3>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç</h3>
                    <input type="number" id="booking-flight" placeholder="ID —Ä–µ–π—Å–∞" min="1">
                    <input type="text" id="booking-name" placeholder="–§–ò–û –ø–∞—Å—Å–∞–∂–∏—Ä–∞">
                    <input type="email" id="booking-email" placeholder="Email">
                    <input type="tel" id="booking-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                    <button class="btn-primary" onclick="createBooking()">üéüÔ∏è –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨</button>
                </div>
            </div>

            <!-- ============== ACCOUNT TAB ============== -->
            <div id="account" class="tab">
                <h2>üë§ –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</h2>
                <div class="account-info">
                    <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
                    <p><strong>–§–ò–û:</strong> <span id="acc-name">-</span></p>
                    <p><strong>Email:</strong> <span id="acc-email">-</span></p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="acc-status">-</span></p>
                    <p><strong>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞:</strong> <span id="acc-date">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="notification"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;

        // ============== INIT ============== 
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            } else {
                showAuthModal();
            }
        });

        // ============== AUTH ============== 
        function switchAuthForm() {
            document.getElementById('login-form').classList.toggle('active');
            document.getElementById('register-form').classList.toggle('active');
        }

        function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            currentUser = {
                name: email.split('@')[0],
                email: email,
                type: 'registered',
                loginTime: new Date().toLocaleString('ru-RU')
            };

            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–£—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!', 'success');
        }

        function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();

            if (!name || !email || !password) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (password.length < 6) {
                notify('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            currentUser = {
                name: name,
                email: email,
                type: 'registered',
                loginTime: new Date().toLocaleString('ru-RU')
            };

            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–£—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
        }

        function guestLogin() {
            currentUser = {
                name: 'Guest',
                email: 'guest@example.com',
                type: 'guest',
                loginTime: new Date().toLocaleString('ru-RU')
            };

            localStorage.setItem('user', JSON.stringify(currentUser));
            showApp();
            notify('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å', 'success');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('app').classList.add('hidden');
            showAuthModal();
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            notify('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
        }

        // ============== UI ============== 
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateAccountTab();
            loadAllFlights();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn:not(.logout)').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = `notification show ${type}`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // ============== ACCOUNT ============== 
        function updateAccountTab() {
            if (!currentUser) return;
            document.getElementById('acc-name').textContent = currentUser.name;
            document.getElementById('acc-email').textContent = currentUser.email;
            document.getElementById('acc-status').textContent = currentUser.type === 'guest' ? '–ì–æ—Å—Ç—å' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
            document.getElementById('acc-date').textContent = currentUser.loginTime;
        }

        // ============== FLIGHTS ============== 
        async function loadAllFlights() {
            try {
                const res = await fetch(`${API_URL}/flights/`);
                const flights = await res.json();
                const list = document.getElementById('flights-list');

                if (!flights || flights.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">–†–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                list.innerHTML = flights.map(f => `
                    <div class="card">
                        <h3>${f.flight_number}</h3>
                        <p><strong>–ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è:</strong> ${f.airline}</p>
                        <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${f.departure_airport_id} ‚Üí ${f.arrival_airport_id}</p>
                        <p><strong>–í—ã–ª–µ—Ç:</strong> ${new Date(f.departure_time).toLocaleString('ru-RU')}</p>
                        <p><strong>–¶–µ–Ω–∞:</strong> ‚ÇΩ${f.price}</p>
                        <p><strong>–ú–µ—Å—Ç–∞:</strong> ${f.available_seats}/${f.total_seats}</p>
                        <button class="btn-select" onclick="selectFlight(${f.id})">üéüÔ∏è –í–´–ë–†–ê–¢–¨</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error:', e);
                notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Å–æ–≤', 'error');
            }
        }

        function selectFlight(id) {
            document.getElementById('booking-flight').value = id;
            switchTab('bookings');
            document.querySelector('[onclick="switchTab(\'bookings\')"]').classList.add('active');
        }

        // ============== AIRPORTS ============== 
        async function addAirport() {
            const code = document.getElementById('airport-code').value.trim().toUpperCase();
            const name = document.getElementById('airport-name').value.trim();
            const city = document.getElementById('airport-city').value.trim();
            const country = document.getElementById('airport-country').value.trim();

            if (!code || !name || !city || !country) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/flights/airports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name, city, country })
                });

                if (res.ok) {
                    notify('–ê—ç—Ä–æ–ø–æ—Ä—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    document.getElementById('airport-code').value = '';
                    document.getElementById('airport-name').value = '';
                    document.getElementById('airport-city').value = '';
                    document.getElementById('airport-country').value = '';
                } else {
                    notify('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
                }
            } catch (e) {
                console.error('Error:', e);
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        // ============== BOOKINGS ============== 
        async function createBooking() {
            const flight = document.getElementById('booking-flight').value.trim();
            const name = document.getElementById('booking-name').value.trim();
            const email = document.getElementById('booking-email').value.trim();
            const phone = document.getElementById('booking-phone').value.trim();

            if (!flight || !name || !email || !phone) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/bookings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flight_id: parseInt(flight),
                        passenger_name: name,
                        passenger_email: email,
                        passenger_phone: phone
                    })
                });

                if (res.ok) {
                    const booking = await res.json();
                    notify(`–ë–∏–ª–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω! ‚Ññ${booking.booking_number || flight}`, 'success');
                    document.getElementById('booking-flight').value = '';
                    document.getElementById('booking-name').value = '';
                    document.getElementById('booking-email').value = '';
                    document.getElementById('booking-phone').value = '';
                } else {
                    notify('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                }
            } catch (e) {
                console.error('Error:', e);
                notify('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }
    </script>
</body>
</html>
